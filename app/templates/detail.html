{% extends "base.html" %}
{% block title %}Item Detail{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-lg-6">
    <img src="{{ url_for('static', filename=item.photo) }}"
         class="img-fluid rounded shadow" alt="product photo">
  </div>
  <div class="col-lg-6">
    <h3 class="mb-2">{{ item.class_name }}</h3>
    <p class="text-muted mb-1">
      Division: <b>{{ item.division }}</b> ¬∑
      Department: <b>{{ item.department }}</b>
    </p>
    <p class="mb-0">{{ item.description }}</p>
  </div>
</div>

<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" data-bs-toggle="tab" href="#tab-reviews" role="tab">
      Reviews ({{ rcount }})
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="tab" href="#tab-write" role="tab">
      Write Review
    </a>
  </li>
</ul>

<div class="tab-content">
  <!-- Reviews tab -->
  <div class="tab-pane fade show active" id="tab-reviews" role="tabpanel">
    {% if reviews|length == 0 %}
      <div class="alert alert-info">No reviews yet.</div>
    {% else %}
      {% for r in reviews %}
      <div class="card mb-3" id="rev-{{ r.id }}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <h6 class="mb-1">{{ r.title or "(no title)" }}</h6>

            {# Optional sentiment badge (only if backend stored them later) #}
            {% if r.get('prediction') == 'Positive' %}
              <span class="badge bg-success">Positive ({{ '%.2f'|format(r.get('confidence', 0)) }})</span>
            {% elif r.get('prediction') == 'Negative' %}
              <span class="badge bg-danger">Negative ({{ '%.2f'|format(r.get('confidence', 0)) }})</span>
            {% endif %}
          </div>

          <p class="mb-2 small text-body">
            {{ r.review_text[:300] }}{% if r.review_text|length > 300 %}‚Ä¶{% endif %}
          </p>

          <div class="d-flex justify-content-between align-items-center small text-muted">
            <div class="d-flex flex-wrap gap-3 align-items-center">

              <!-- Rating as stars -->
              <span>
                {% set full = (r.rating or 0)|int %}
                {% for i in range(1,6) %}
                  <span class="{% if i <= full %}text-warning{% else %}text-secondary{% endif %}">‚òÖ</span>
                {% endfor %}
                <span class="ms-1">{{ r.rating }}/5</span>
              </span>

              <!-- Recommended IND -->
              {% if r.recommended == 1 %}
                <span class="badge bg-success">Recommended</span>
              {% else %}
                <span class="badge bg-secondary">Not Recommended</span>
              {% endif %}

              <!-- Positive Feedback Count -->
              <span title="Helpful votes">üëç {{ r.positive_feedback or 0 }}</span>

              <!-- Age -->
              <span>Age: {{ r.age or "?" }}</span>
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary"
                      onclick="openEdit({{ r|tojson }})">Edit</button>
              <button class="btn btn-sm btn-outline-danger"
                      onclick="deleteReview({{ r.id }})">Delete</button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}

      {% if rpages and rpages > 1 %}
      <nav class="mt-3">
        <ul class="pagination pagination-sm">
          <li class="page-item {% if rpage<=1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.detail', item_id=item.clothing_id, rpage=rpage-1) }}">Prev</a>
          </li>
          {% for p in range(1, rpages+1) %}
          <li class="page-item {% if p==rpage %}active{% endif %}">
            <a class="page-link" href="{{ url_for('main.detail', item_id=item.clothing_id, rpage=p) }}">{{ p }}</a>
          </li>
          {% endfor %}
          <li class="page-item {% if rpage>=rpages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.detail', item_id=item.clothing_id, rpage=rpage+1) }}">Next</a>
          </li>
        </ul>
      </nav>
      {% endif %}
    {% endif %}
  </div>

  <!-- Write tab -->
  <div class="tab-pane fade" id="tab-write" role="tabpanel">
    <div class="card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-8">
            <label class="form-label">Title</label>
            <input id="f-title" class="form-control" placeholder="Title">
          </div>
          <div class="col-md-2">
            <label class="form-label">Age</label>
            <input id="f-age" type="number" class="form-control" value="30" min="1" max="120">
          </div>
          <div class="col-md-2">
            <label class="form-label">Rating</label>
            <select id="f-rating" class="form-select">
              <option>1</option><option>2</option><option>3</option>
              <option selected>4</option><option>5</option>
            </select>
          </div>
        </div>

        <label class="form-label mt-3">Review Text</label>
        <textarea id="f-text" class="form-control" rows="3" placeholder="Write your review‚Ä¶"></textarea>

        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">Recommendation</label>
            <select id="f-rec" class="form-select">
              <option value="0">Not Recommended</option>
              <option value="1" selected>Recommended</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Helpful votes (optional)</label>
            <input id="f-pf" type="number" class="form-control" value="0" min="0">
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-primary" onclick="aiSuggest()">AI Suggest</button>
          <button class="btn btn-primary" onclick="submitReview()">Submit</button>
          <button class="btn btn-outline-secondary" onclick="clearWrite()">Clear</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function toast(msg, type='info') {
    const el = document.createElement('div');
    el.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
    el.style.zIndex = 2000;
    el.innerText = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1800);
  }

  // AI Suggest -> call the model_info JSON API you already have
  async function aiSuggest() {
    const reviewText = document.getElementById('f-text').value.trim()
                      || document.getElementById('f-title').value.trim();
    if (!reviewText) { toast('Type something first', 'warning'); return; }
    try {
      const res = await fetch('{{ url_for("model_info.api_predict") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: reviewText })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'AI error');
      toast(`AI: ${data.label} (${(data.prob || 0).toFixed(2)})`,
            data.label === 'Positive' ? 'success' : 'danger');
      // Optional: auto set recommendation from AI
      document.getElementById('f-rec').value = data.label === 'Positive' ? '1' : '0';
    } catch (e) {
      toast('AI suggest failed', 'danger');
    }
  }

  async function submitReview() {
    const payload = {
      title: document.getElementById('f-title').value.trim(),
      review_text: document.getElementById('f-text').value.trim(),
      age: parseInt(document.getElementById('f-age').value || '0', 10),
      rating: parseInt(document.getElementById('f-rating').value, 10),
      recommended: parseInt(document.getElementById('f-rec').value, 10),
      positive_feedback: parseInt(document.getElementById('f-pf').value || '0', 10),
    };
    if (!payload.title || !payload.review_text) {
      toast('Please fill title & text', 'warning'); return;
    }
    try {
      const res = await fetch('{{ url_for("main.api_create_review", item_id=item.clothing_id) }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data.ok) throw new Error();
      location.reload();
    } catch {
      toast('Submit failed', 'danger');
    }
  }

  function clearWrite() {
    ['f-title','f-text','f-age','f-pf'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('f-rating').value = '4';
    document.getElementById('f-rec').value = '1';
  }

  async function deleteReview(id) {
    if (!confirm('Delete this review?')) return;
    try {
      const url = '{{ url_for("main.api_delete_review", review_id=0) }}'.replace('0', id);
      const res = await fetch(url, { method: 'DELETE' });
      const data = await res.json();
      if (!data.ok) throw new Error();
      document.getElementById('rev-' + id)?.remove();
      toast('Deleted', 'success');
    } catch {
      toast('Delete failed', 'danger');
    }
  }

  function openEdit(r) {
    toast('Edit UI not implemented in this snippet.', 'secondary');
  }
</script>
{% endblock %}